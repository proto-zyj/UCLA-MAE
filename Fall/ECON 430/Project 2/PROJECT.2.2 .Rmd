---
title: "PROJECT2"
author: "YITE ZHU, YUANJIAN ZHOU, ZIYING CHENG"
date: "2019/12/12"
output:
  pdf_document: default
  word_document: default
---
# I. Introduction
## 1. Background

Energy has always been a major concern. It is closely related to development and national security, and is associated with all aspects of people's daily life. Despite that for decades, diversified energy sources have been introduced to generate electricity, coal still remains to be one of the most economical sources, accounting for  a great proportion of electricity generation. The pollution and environmental externalities of coal usage in electricity generation, however, have been one major political issue, especially for European Union. Meanwhile, that the resource reserve is limited also makes it not as economical as before. Led by countries like Germany, the world is struggling to make a trade-off between economic growth and environmental protection. And Germany has been doing a great job in withdrawing the coal for fuel gradually. Being one of the most important economy and electricity & coal consumer, Germany is a good case for analytical problems relating to electricity generation and environment. This report takes a closer look at the electricity generation by coal in Germany, builds time series models, tries to develop a comprehensive understanding of its trend and volatility, and make predictions, to help provide a glimpse into broader perspective of global energy market.

## 2.data description
The report utilizes two serial monthly data of German coal from Jan 2002 to Aug 2019, provided by Federal Statistics Office Germany. One series is monthly data of electricity generated by crude lignite, referred to as brown coal. With a relatively low carbon content around 60-70, it is considered the lowest rank of coal, also most harmful to health, while the cost of it remains cheap. The other series describes the electricity generated by hard coal, which is a usual source adopted by economies around the world. Blessed with the highest carbon content, it has the highest energy density, ranked the highest of all coals. From the basic knowledge, the two raw materials for electricity generation have positive relationships to the whole coal industry production development and fluctuations. In addition, they may be negatively correlated with each other because they are both exclusively used to generate  electricity , acting as the substitutional products to some extent.

Thus, it is interesting to explore their respective innovations through time and the relationship between them from the view of time series. The center of the study is to fit time series model for them and make predictions. Then, vector autoregression (VAR) are applied to figure out the interdependence between them. To sum up, we generate a full model to optimize the performance of model and conduct forecast, bringing a more accurate prospect of the Germany electricity generation by coal.
The Unit of monthly data is megawatt-hours(MWH). To narrow down the scale of data and transform data to a similar scale, as well as easing potential heteroskedasticity, we exert log transformation to data. Then we use different models and plots to make analysis as follows.


# II. Results

```{r, echo=F, message=F}
library(lattice)
library(foreign)
library(MASS)
library(car)
require(stats)
require(stats4)
library(KernSmooth)
library(fastICA)
library(cluster)
library(leaps)
library(mgcv)
library(rpart)
library(pan)
library(mgcv)
library(DAAG)
library("TTR")
library(tis)
require("datasets")
require(graphics)
library("forecast")
#install.packages("astsa")
#require(astsa)
library(xtable)
library(stats)
library(tseries)
library(AER)
library(lmtest)
library(vars)
library(ggplot2)
library(strucchange)
library(cvTools)
library(boot)
library(rpart)
library(greybox)
```

## 1
```{r, echo=F}
# import the data
d = read.csv('t9.csv', header=T)
d = data.frame(d)
colnames(d) =c('time', 'lign', 'coal')
#head(d)

# Transform the data into time series
t = ts(d$time, start=2002.1, freq=12)
nt = ts(d$lign, start=2002.1, freq=12)
ct = ts(d$coal, start=2002.1, freq=12)
lt = log(t)
nt = log(nt)
ct = log(ct)

```

```{r, echo=F, message=F}
# Check acf and pacf for Crude Lignite
tsdisplay(nt, lag=48, main='Crude Lignite')

# Check acf and pacf for Coal
tsdisplay(ct, lag=48, main='Coal')

# Plot a rough sketch of the two series
cot = data.frame(t, nt, ct)

g1 = ggplot(cot, aes(x=t)) + 
  geom_line(aes(x=t, y=nt), col='#333999') +
  geom_line(aes(x=t, y=ct), col='#ff0066') + 
  theme_bw() +
  labs(x='Time', y='Electricity Generated / MWh') + 
  theme(axis.text.x = element_text(face="bold", size=10),
          axis.text.y = element_text(face="bold", size=10))
  
g1
```

The plot of two series have revealed the characteristics of the two log series. We can observe a vague drift in the log series. Cyclicality and seasonality are present considering the stochastic fluctuation in the overall series. It is more prudent to include all three components in the model.

Then we turn to ACF and PACF for more implications. The seasonality is apparent judging from the periodic repetition of spikes in acf. Acf and Pacf both displays decaying characteristic but with periodic repetitions and fluctuations. This means that the two series requires more complicated models than simple MA(q) or AR(p).

To understand the interdependence, we plot the two series in one plot. The resulting graph shows the correlation between two series, which points to the possible lead-lag relationship of the two series and stresses the necessity of VAR model.

## 2

```{r, echo=F}
# Build separate arima models for the two series
n1 = auto.arima(nt,xreg=lt)
c1 = auto.arima(ct,xreg=lt)
S(n1)
coeftest(n1)
S(c1)
coeftest(c1)
```
```{r, echo=F}
plot(nt, col='blue1',lwd=1, main='Fit for Crude Lignite', xlab='Time',
     ylab='Electiricity generated')
lines(n1$fitted, col='red1', lwd=1)
legend("bottomleft",pch=c(15,15),legend=c("Data","Fit"),
       col=c('blue1','red1'),bty="n")

plot(ct, col='blue3',lwd=1, main='Fit for Coal', xlab='Time',
     ylab='Electiricity generated')
lines(c1$fitted, col='red3', lwd=1)
legend("bottomleft",pch=c(15,15),legend=c("Data","Fit"),
       col=c('blue1','red1'),bty="n")

Box.test(n1$residuals)
Box.test(c1$residuals)
```
Using Algorithms we obtain baseline models as follows:

Crude Lignite model has ARIMA(0,1,3)(2,0,0)[12] with log trend.

Coal has ARIMA(1,1,1)(0,0,2)[12] with log trend.

The results suggest that the model will include stochastic seasonality, trend, and cycles.

On graph, the fitted line captures the stochastic seasonality and cycles in a good manner. The residuals from both models are tested to be normal. The results of Box-Pierce test suggest their residuals are both white noise, demonstrated that all the patterns in original process have been detected.

## 3
To produce a valid model for crude lignite, we try different components step by step, based on the ARIMA results from the baseline in part b. We started by digging into a combination of different trends and season, then trend and cycle, then all three components. AIC and BIC pointed to a best choice of all trials.

Overall, trend + season is too simple and is weak in explaining the arbitrary fluctuations in the series. While trend + cycle appear desirable, a lack of seasonality in the model still fails to replicate periodic repetitions, especially those that goes with calenders. It might be acceptable for other series, but considering our data is about energy generation, seasonality is expected to be of some significance due to the link between produciton activities and seasons.

The result is not so surprising that a model with all three components performs the best.

```{r, echo=F, fig.width=8, fig.height=8, message=F, warning=F}
# Try a seasonal + trend model for Crude Lignite

n3=tslm(nt~lt+season)

par(mfrow=c(2,1))
plot(nt,ylab="Crude Lignite", xlab="Time", lwd=2, col='skyblue2',main="seasonal+trend1  model for Lignite")
lines(n3$fitted.values,col="red2",lwd=2,lty=2)
legend("bottomleft",pch=c(15,15),legend=c("Data","Fit"),
       col=c('skyblue2','red2'),bty="n")

plot(n3$res, ylab="Crude Lignite Residuals",type='l',xlab="Time",lwd=2)

par(mfrow=c(2,1))
acf(n3$residuals, lag=36, main="ACF-Crude Lignite Residuals")
pacf(n3$residuals, lag=36, main="PACF-Crude Lignite Residuals")


# Change a trend, the result is not improved 
n32=tslm(nt~t+season)

par(mfrow=c(2,1))
plot(nt,ylab="Crude Lignite", xlab="Time", lwd=2, col='skyblue2',main= "seasonal+trend2 model for Lignite")
lines(n32$fitted.values,col="red2",lwd=2,lty=2)
legend("bottomleft",pch=c(15,15),legend=c("Data","Fit"),
       col=c('skyblue2','red2'),bty="n")

plot(n32$res, ylab="Crude Lignite Residuals",type='l',xlab="Time",lwd=2)

par(mfrow=c(2,1))
acf(n32$residuals, lag=36, main="ACF-Crude Lignite Residuals")
pacf(n32$residuals, lag=36, main="PACF-Crude Lignite Residuals")

# Try a trend + cycle model, we see that the fit is not well.
# much of the repeated fluctuations, which can be explained using 
# seasonal dummies or seasonal ARIMA are not accounted for here.

n4=Arima(nt, order=c(0,1,3), xreg=lt)

par(mfrow=c(2,1))
plot(nt,ylab="Crude Lignite", xlab="Time", lwd=2, col='skyblue2', main="trend + cycle model ")
lines(n4$fitted,col="red2",lwd=2,lty=2)
legend("bottomleft",pch=c(15,15),legend=c("Data","Fit"),
       col=c('skyblue2','red2'),bty="n")

plot(n4$res, ylab="Crude Lignite Residuals",type='l',xlab="Time",lwd=2)

par(mfrow=c(2,1))
acf(n4$residuals, lag=36, main="ACF-Crude Lignite Residuals")
pacf(n4$residuals, lag=36, main="PACF-Crude Lignite Residuals")

# To sum up, after iterated trial and comparison of BIC, we arrive
# at the following model

n2 = Arima(nt, order=c(1,1,2), 
           seasonal = list(order=c(1,0,1)), include.drift=T)
par(mfrow=c(2,1))
plot(nt,ylab="Crude Lignite", xlab="Time", lwd=2, col='skyblue2')
lines(n2$fitted,col="red2",lwd=2,lty=2)
legend("bottomleft",pch=c(15,15),legend=c("Data","Fit"),
       col=c('skyblue2','red2'),bty="n")

plot(n2$res, ylab="Crude Lignite Residuals",type='l',xlab="Time",lwd=2)

par(mfrow=c(2,1))
acf(n2$residuals, lag=36, main="ACF-Crude Lignite Residuals")
pacf(n2$residuals, lag=36, main="PACF-Crude Lignite Residuals")

# BIC and AIC suggest the last model is the best
AIC(n3, n32, n4, n2)
BIC(n3, n32, n4, n2)

# The Residuals are White Noise
Box.test(n2$residuals)
```

Similarly, we produce a valid model for coal. As before, the models that capture all three components tend to outperform the others. 

```{r, echo=F, fig.width=8, fig.height=8, message=F, warning=F}

# Try a seasonal + trend model for Coal
c3=tslm(ct~lt+season)

par(mfrow=c(2,1))
plot(ct,ylab="Coal", xlab="Time", lwd=2, col='skyblue2')
lines(c3$fitted.values,col="red2",lwd=2,lty=2)
legend("bottomleft",pch=c(15,15),legend=c("Data","Fit"),
       col=c('skyblue2','red2'),bty="n")

plot(c3$res, ylab="Coal Residuals",type='l',xlab="Time",lwd=2)

par(mfrow=c(2,1))
acf(c3$residuals, lag=36, main="ACF-Coal Residuals")
pacf(c3$residuals, lag=36, main="PACF-Coal Residuals")


# Change a trend, the result is not improved 
c32=tslm(ct~t+season)

par(mfrow=c(2,1))
plot(ct,ylab="Coal", xlab="Time", lwd=2, col='skyblue2')
lines(c32$fitted.values,col="red2",lwd=2,lty=2)
legend("bottomleft",pch=c(15,15),legend=c("Data","Fit"),
       col=c('skyblue2','red2'),bty="n")

plot(c32$res, ylab="Coal Residuals",type='l',xlab="Time",lwd=2)

par(mfrow=c(2,1))
acf(c32$residuals, lag=36, main="ACF-Coal Residuals")
pacf(c32$residuals, lag=36, main="PACF-Coal Residuals")

# Try a trend + cycle model 

c4=Arima(ct, order=c(1,1,1), xreg=lt)

par(mfrow=c(2,1))
plot(ct,ylab="Coal", xlab="Time", lwd=2, col='skyblue2')
lines(c4$fitted,col="red2",lwd=2,lty=2)
legend("bottomleft",pch=c(15,15),legend=c("Data","Fit"),
       col=c('skyblue2','red2'),bty="n")

plot(c4$res, ylab="Coal Residuals",type='l',xlab="Time",lwd=2)

par(mfrow=c(2,1))
acf(c4$residuals, lag=36, main="ACF-Coal Residuals")
pacf(c4$residuals, lag=36, main="PACF-Coal Residuals")

# To sum up, after iterated trial and comparison of BIC, we arrive
# at the following model

c2 = Arima(ct, order=c(1,1,1), 
           seasonal = list(order=c(1,0,1)), include.drift=T)
par(mfrow=c(2,1))
plot(ct,ylab="Coal", xlab="Time", lwd=2, col='skyblue2')
lines(c2$fitted,col="red2",lwd=2,lty=2)
legend("bottomleft",pch=c(15,15),legend=c("Data","Fit"),
       col=c('skyblue2','red2'),bty="n")

plot(c2$res, ylab="Coal Residuals",type='l',xlab="Time",lwd=2)

par(mfrow=c(2,1))
acf(c2$residuals, lag=36, main="ACF-Coal Residuals")
pacf(c2$residuals, lag=36, main="PACF-Coal Residuals")

# BIC and AIC suggest the last model is the best
AIC(c3, c32, c4, c2)
BIC(c3, c32, c4, c2)

# The Residuals are White Noise
Box.test(c2$residuals)
```

In the end, we conclude our model results as the following:

```{r, echo=F}
# The Final Model for the following parts
lt = log(t)

n2 = Arima(nt, order=c(1,1,2), 
           seasonal = list(order=c(1,0,1)), include.drift=T)
S(n2)
coeftest(n2)

c2 = Arima(ct, order=c(1,1,1), 
           seasonal = list(order=c(1,0,1)), include.drift=T)
S(c2)
coeftest(c2)
```

For coal lignite: After doing first difference and removing drift from the log process, we get a stationary process and using ARMA to fit the remaining pattern, detecting from acf,pacf plot.Finally, we acquire the full model composed of cycle, drift and seasonality. Among the terms in model,the drift is negative, showing the log process is decreasing slowly, which is an essential part of the model. The estimated coefficient of AR(1) is statistically significant at 0.1% level and the terms AR(2),SAR(1) SMA(1) are significant under 1% level.Despite the insigificance to some extent of MA(1), the model still turns out to be good as a whole.The RMSE is 0.0528 and BIC is -594.36, suggesting the model performs pretty desirable for good of fitness.

For hard coal:Similarly, the log process is also stationary after first difference, drift removal, and including seasonal autoregression.Accordingly, we utilize cycle model to fit the remaining pattern in the stationary process, leading to the full model.Specificlly, the drift of model is negative, indicating a decreasing trend of log process, playing a nonnegligible role in our model. As for seasonality, estimated coefficients of SAR(1) and SMA(2) are both statistically significant under the confidence level of 99.9%. For the cycle part,AR(1) is not statistically significant while MA(1) is significant under 0.1%. Although not all independent variables in our SARMA(1,1,1)(1,0,1)[12] with drift, all the compositions still indispensable, which preform well in forecast cooperatively.RMSE is 0.1290 and BIC is -212, suggesting the model is pretty good.


## 4

To check the goodness of fit for our model, we check the residuals and fitted values of our models.

As can be seen from graph, our model fits are good in reflecting the zig-zags of real data for either of the series. The residuals from both series seemed to be zero mean series, the autoregressiveness are not unacceptably apparent, and the variance seemed stable most of the time. The two models seem to have some resemblance of white noise residuals, but for future work, introducing GARCH models to throughly account for a changing variance would be a step up to improve the performance of our models. 

```{r, echo=F, fig.width=8, fig.height=8, message=F}
library(ggpubr)
# create the dataframe to put in
pr1 = data.frame(t, fv = n2$fitted, ehat = n2$residuals, dat=nt)
pr2 = data.frame(t, fv = c2$fitted, ehat = c2$residuals, dat=ct)

l = c("Crude Lignite","Coal")

rfv <- function(data, title){
  # Plot for each models' residuals and fitted values
  g1 = ggplot(data, aes(x=t, y=ehat))+
    geom_line(col='#3300cc') +
    labs(x='Time', y='Residuals', title=title) + theme_bw()
  
  g2 = ggplot(data, aes(x=t, y=fv))+
    geom_line(col='#0000cc', alpha=0.5) +
    geom_line(aes(x=t,y=dat), col='#ff3333') +
    labs(x='Time', y='Fitted Values', title=title) + theme_bw()
  g = ggarrange(g1, g2, ncol=1, nrow=2)
  return(g)
}
rfv(pr1, l[1])

```
```{r, echo=F, fig.width=8, fig.height=8, message=F}
# Paint the graph using two code blocks in r_markdown
# To neatly knit the pictures in the output pdf or doc file

rfv(pr2, l[2])

```

## 5

To validate our observation about residuals, we examine the ACF and PACF of both residual series. On the whole, the two series have ACF and PACF that have virtually no spikes. No major time dependence are observed. These suggest that the models have almost explained a large proportion of the variation in the series. These well-behaved patterns suggest that we have two white noise residual series.


```{r, echo=F, fig.width=8, fig.height=8}
# acf pacf for crude lignite
par(mfrow=c(2,1))
acf(n2$residuals, main='ACF - Residual from Crude-Lignite-Generated Electricity',
    xlab='Displacement')
pacf(n2$residuals, main='PACF - Residual from Crude-Lignite-Generated Electricity',
     xlab='Displacement')

# acf pacf for coal
par(mfrow=c(2,1))
acf(c2$residuals, main='ACF - Residual from Coal-Generated Electricity', xlab='Displacement')
pacf(c2$residuals, main='PACF - Residual from Coal-Generated Electricity', xlab='Displacement')

```


## 6
```{r, echo=F}
# plot the CUSUM
plot(efp(n2$residuals~1, type='Rec-CUSUM'), main='CUSUM Crude Lignite')

plot(efp(c2$residuals~1, type='Rec-CUSUM'), main='CUSUM Coal')

```

CUSUM does not go over the boundaries in either model. It fluctuates closely along the 0 baseline, Meaning that the models for the two series both works.

## 7
```{r, echo=F}
rn = recresid(n2$residuals~1)
plot(rn, pch=16, col='darkred', 
     ylab='Recursive Residuals for Crude Lignite')

rc = recresid(c2$residuals~1)
plot(rc, pch=16, col='skyblue1', 
     ylab='Recursive Residuals for Coal')
```

The recursive residuals seem to fluctuate around zero-mean, meaning that the model has basically accounted for most of the variation in the series, and the coefficient estimates are relatively robust, especially when doing forecast.


## 8
```{r, echo=F, warning=F}
# AIC and BIC standard for both series of models
AIC(n3, n32, n4, n2)
BIC(n3, n32, n4, n2)
AIC(n3, n32, n4, n2)
BIC(n3, n32, n4, n2)

# Error Metrics for models
accuracy(n3)
accuracy(n32)
accuracy(n4)
accuracy(n2)

accuracy(c3)
accuracy(c32)
accuracy(c4)
accuracy(c2)

```

Our selected models has the best BIC and AIC among its siblings.

The error metrics are also demonstrating well-behaved properties of our model. The error is relatively small, regardless of standards utilized.


## 9
```{r, echo=F}
# Forecast 12-step ahead
#new = ts(start=2019.9, end=2020.9, freq=12)
#new = seq(2019+8/12, by=1/12, length=12)
#newt = log(new)
plot(forecast(n2, h=12), main='Forecasting for Crude Lignite')
plot(forecast(c2, h=12), main='Forecasting for Coal'
     ,shadecols="oldstyle")
```

The point forecast from both models, as well as their interval estimates, are reflecting the time-variant nature of both series.The line potrays the point prediction of the process, the narrower shade suggests the confidence interval and the wider shade indicates predict interval of the proccess, constitute a comprehensive picture of time series forecast.

## 10
```{r, fig.width=8, fig.height=8, echo=F}
# Plot
ccf(nt, ct, ylab="Cross-Correlation Function", 
    main = "Crude Lignite and Coal CCF")

ccf(ct,nt, ylab="Cross-Correlation Function", 
    main = "Coal and Crude Lignite CCF")

# Build VAR model
co = data.frame(nt, ct)

VARselect(co, lag.max=10)
v1 = VAR(co, 1)
summary(v1)


# plot the model
plot(v1)
```

According to the SARMA model we constructed for Lignite and Hard coal above, they have auto regression process themselves. Then from ccf plot, we can see they are significantly correlated with the other lagged by 0-2 months, which provides a strong support to VAR model.

Then we try to build VAR(1) and VAR(2) model and get better adjust R square and statistical significance. By comparing between AIC, BIC of different models, VAR(1) is best.
For Var(1), nt = nt.l1 + ct.l1 + const the auto regression lag 1 of hard coal,AR(1) crude lignite and constant are all statistically significant,with R-squared 0.4638.
For the model, ct = nt.l1 + ct.l1 + const only the auto regression lag 1 of hard coal itself is statistically significant, with adjust R-square 0.623.
The model seems to capture the autoregressive nature of both series, and, above that, have shown some interdependence between the two. The causality is not yet clear, simply judging from CCF plots.

## 11
```{r, echo=F}
irf(v1)
plot(irf(v1))

```

We can see from the Impulse Response function that both variables are sensitive to their own lagged terms.There is a jump on the value than the influence will decay to zero.As for cross effects,while lagged coal has an influence on crude lignite, the opposite does not hold.If we exert a positive shock on Lignite, coal will jump and converge to 0 gradually.If we increase value of coal, Lignite will increase a little and then decay.

This asymmetry is pointing to the fact that coal can be used to predict the sequential series of crude lignite.


## 12
```{r, echo=F}

grangertest(nt, ct)
grangertest(ct, nt)

```

In coherence with the previous IRF results, Granger Causality test result suggests that coal is influencing crude lignite, while the other way around does not hold.

Our intuition is that, crude lignite is a cheaper, but environmentally unfriendly source of energy. Under the pressure from green parties and relevant environment protectionist groups, the usage of crude lignite will face relatively large pressure, making it a supplementary to coal. It is natural, therefore, to suspect that to suppliment for shortage of electricity, large amount of coal-generated electricity will be followed by a supplimentary amount of crude-lignite-generated electricity. The same happens when there is a drop in coal-generated electricity, which will be followed by a drop in crude-lignite-generated electricity due to a need to reduce social pressure. The Granger-Causality test have verified this hypothesis in some sense.

## 13
```{r, echo=F}
# Forecast 12-step ahead
varpred = predict(v1, h=12)
plot(varpred, main=c('Forecasting for Crude Lignite',
                     'Forecasting for Coal'))
plot(stability(v1, type = "Rec-CUSUM"), plot.type="single")
```

The CUSUM fluctuates along the zero line, and don't go beyond red boundary, suggesting the model is pretty robust.

Since the VAR model is overly simplified and cannot explain for seasonality or trend, the fit is, not surprisingly, worse compared to ARMA models.The latter, with relatively complicated components, capture the trend comparably more efficiently.

## 14
### (a)
 In practice, since we do not know the future yet, we can not evaluate the prediction of our models in a normal way. Most often, we will separate our data into estimation set and prediction set, and used the model fitted in estimation set to predict data in prediction set. Since data in prediction set comes from the past, we usually call this process backtest.
Here in our analysis, we have 212 observations for each variable from Jan 2002 to Aug 2019. We separate them into 140 estimation ones and 72 prediction ones.
First, we use a recursive backtesting scheme and forecast 12 steps ahead for each iteration. For evaluating prediction accuracy, we calculate the Mean Absolute Percentage Error at each step and plot the MAPE over each iteration. 
```{r, echo=F, warning=F}
# Just to make sure the data is correct
t = ts(d$time, start=2002.1, freq=12)
nt = ts(d$lign, start=2002.1, freq=12)
ct = ts(d$coal, start=2002.1, freq=12)
lt = log(t)
nt = log(nt)
ct = log(ct)


# forecast 
model_l = "forecast(Arima(data, order=c(1,1,2), seasonal = c(1,0,1),
method='CSS', include.drift=T),h = h,level=95)"
model_h = "forecast(Arima(data, order=c(1,1,1), seasonal = c(1,0,1),
method='CSS', include.drift=T),h = h,level=95)"
ourValue = "mean"

# separation : training 140 test 72, you can make your own
n12rec = ro(nt,h=12,origins = 61,call=model_l,value=ourValue,
                     ci=F,co=T)
n1rec = ro(nt,h=1,origins = 72,call=model_l,value=ourValue,
                    ci=F,co=T)
n12rol = ro(nt,h=12,origins = 61,call=model_l,value=ourValue,
                   ci=T,co=T)
n1rol = ro(nt,h=1,origins = 72,call=model_l,value=ourValue,
                  ci=T,co=T)
c12rec = ro(ct,h=12,origins = 61,call=model_h ,value=ourValue,
                     ci=F,co=T)
c1rec = ro(ct,h=1,origins = 72,call=model_h ,value=ourValue,
                    ci=F,co=T)
c12rol = ro(ct,h=12,origins = 61,call=model_h ,value=ourValue,
                   ci=T,co=T)
c1rol = ro(ct,h=1,origins = 72,call=model_h ,value=ourValue,
                  ci=T,co=T)

# MAPE over each step for recursive f12
l_f12_MAPE_eachstep = apply(abs((n12rec$mean-n12rec$holdout)
                                /n12rec$holdout),1,mean)
l_f12_MAPE_eachiteration = apply(abs((n12rec$mean-n12rec$holdout)
                                     /n12rec$holdout),2,mean)
plot(l_f12_MAPE_eachstep, main='Crude Lignite Recursive 12-step MAPE each step')
plot(l_f12_MAPE_eachiteration, main='Crude Lignite Recursive 12-step MAPE each iteration')
plot(n12rec)


h_f12_MAPE_eachstep = apply(abs((c12rec$mean-c12rec$holdout)
                                /c12rec$holdout),1,mean)
h_f12_MAPE_eachiteration = apply(abs((c12rec$mean-c12rec$holdout)
                                     /c12rec$holdout),2,mean)
plot(h_f12_MAPE_eachstep, main='Coal Recursive 12-step MAPE each step')
plot(h_f12_MAPE_eachiteration, main='Coal Recursive 12-step MAPE each iteration')
plot(n12rol)

```
As is shown, the MAPE over each step is increasing, and the MAPE over each iteration is stationarily small, except the rapid rising at end, which may be caused the plummet of our original data.

(b)
Then, we shorten the forecast horizon to 1 step ahead, and plot Absolute Percentage Error. 
```{r, echo=F}
# Recursive Backtest 1-step ahead
# APE over each iteration for recursive f1
l_f1_recursive_APE_eachiteration = abs(n1rec$mean-n1rec$holdout)/n1rec$holdout
l_f1_recursive_APE_eachiteration = t(l_f1_recursive_APE_eachiteration)
plot(l_f1_recursive_APE_eachiteration, main='Crude Lignite Recursive 1-step APE each iteration')
plot(n1rec)

h_f1_recursive_APE_eachiteration = abs(c1rec$mean-c1rec$holdout)/c1rec$holdout
h_f1_recursive_APE_eachiteration = t(h_f1_recursive_APE_eachiteration)
plot(h_f1_recursive_APE_eachiteration, main='Coal Recursive 1-step APE each iteration')
plot(n1rol)

```
### (c)
Based on our findings, there is no significant difference between the performance of 1 step ahead and 12 step aheads, for crude lignite most of MAPE is below 0.005, for hard coal most of MAPE is below 0.015.

### (d) 
Next, we switch to the rolling window scheme. Not surprisingly, all the plots show similar patterns as above. 

```{r, echo=F}
# Rolling Backtest 12-step ahead

# forecast error over each iteration for rolling f12
l_f12_rolling_MAPE_eachiteration = apply(abs((n12rol$mean-n12rol$holdout)
                                     /n12rol$holdout),2,mean)
plot(l_f12_rolling_MAPE_eachiteration)

h_f12_rolling_MAPE_eachiteration = apply(abs((c12rol$mean-c12rol$holdout)
                                     /c12rol$holdout),2,mean)
plot(h_f12_rolling_MAPE_eachiteration)



# forecast error over each interation for rolling f1
l_f1_rolling_APE_eachiteration = abs(n1rol$mean-n1rol$holdout)/n1rol$holdout
l_f1_rolling_APE_eachiteration = t(l_f1_rolling_APE_eachiteration)
plot(l_f1_rolling_FE_eachiteration)

h_f1_rolling_APE_eachiteration = abs(c1rol$mean-c1rol$holdout)/c1rol$holdout
h_f1_rolling_APE_eachiteration = t(h_f1_rolling_APE_eachiteration)
plot(h_f1_rolling_FE_eachiteration)


```


### (e)
Comparing the errors found using different schemes, we find that there is no apparent difference and all the errors are very small, which tell us that our data is stationary and our model is quite stable.

# III Conclusions and Future Work

In this report, we focus on the development of electricity generation through crude lignite and hard coal in Germany with respect to time. Using time series analysis, we capture the drift, seasonality, and cycles in both log series. We build S-ARIMA models for each series by observing the series, and try linear trend, linear trend plus seasonality, linear trend plus seasonality and cycle,etc., in a step-by-step fashion. Our full ARIMA models are as follows:
 
1.Crude Lignite: The log process is stationary after first difference, drift removal, the seasonality of which are modeled combining seasonal autoregression of order 1, and 1-period seasonal moving average with frequency of 12. The full model consists of  cycle, composed of 1-period autoregression and 2-period moving average, and drift, seasonality described above. The estimated coefficients are statistically significant, and the residual is white noise, suggesting that we have effectively detected the patterns in the process. The RMSE is 0.0528 and BIC is -594.36, suggesting the model is pretty good, also confirmed by forecast plot and CUSUM plot.

ARIMA(1,1,2)(1,0,1)[12] with drift

2 Hard coal:  Similarly, the log process is also stationary after first difference, drift removal, and including seasonal autoregression at lag 1 and first order moving average process with frequency of 12. Finally, we get full model by adding cycle composed of first order  autoregression and first order moving average. The estimated coefficients are statistically significant, and the residual is white noise, suggesting we have effectively detected the patterns in the process. The RMSE is 0.1290 and BIC is -212, suggesting the model is pretty good, also confirmed by forecast plot and CUSUM plot.

ARIMA(1,1,1)(1,0,1)[12] with drift
 
Via Backtesting our models, we can confirm our conclusion that both models perform well in forecasting, no matter using recursive backtesting or rolling window backtesting. To be more specific, our models are more suitable and reliable for short term prediction than for long term prediction.
 
On the other hand, we turn to the interaction between two variables and find that there is close cross correlation between them. Granger-Causality test results implies that past electricity generation of hard coal can be used to predict future electricity generation of  crude lignite, while the other way around does not work, leading to our VAR(1) model as follows:

Lignitet= 0.4580 Lignitet-1 + 0.1035 Coalt-1 + 7.1839

First lag of  hard coal and first lag of lignite itself provide a good model for crude lignite. All the estimated coefficients are statistically significant.
 
However, since our VAR model does not include the seasonality which influences coal significantly, VAR doesn't provide better prediction power compared to ARIMA model.
 
As for future work, there are several things we may take into consideration. First, we may try to add seasonality to VAR model to acquire better fit. Next, sudden turning points appeared in the trends of coal series, owing to the government policy to some extent, so it is reasonable to include some policy dummies in the model, and may also consider the use of general Piecewise Regression to better fit the model. We may make comparative study between different countries to cultivate a better understanding of traditional fuel withdrawing process and their interaction with policies.

# IV Reference
1.Svetunkov, I. (2019). Rolling Origin. Retrieved from https://cran.r-project.org/web/packages/greybox/vignettes/ro.html.

# V Code



